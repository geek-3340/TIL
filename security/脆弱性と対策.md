# 脆弱性や攻撃手法とその対策まとめ

## 🔐 脆弱性とは？

脆弱性（ぜいじゃくせい）とは、アプリやサービスにある「セキュリティの弱点」のこと。  
これ攻撃者が見つけると、情報を盗まれたり、アプリを勝手に操作されたりする危険があります。

セキュリティ対策はあらゆる攻撃を想定しなければならず、問題発生時の損害が非常に大きい場合も多く、リリース時には完璧（にできるだけ近い形）にしておくことが求められます。

また、フレームワークやライブラリなどを利用する際、どのようにセキュリティが担保されているか理解することも重要です。
開発チームに途中から加わった際、セキュリティが全く考慮されていないアプリケーションに出会うことがあるかもしれません。
（残念ながら「動作しているだけ」のアプリケーションは実在します）

---

## 🛠️ SQLインジェクション（SQL Injection）

### 📌 詳細説明
データベースに対して命令（SQL）を送るとき、**悪意のある文字列を混ぜて**不正にデータを読み取ったり、消したり、操作したりする攻撃。

たとえば、ログイン画面で以下のようなSQLが使われていたとします：

```sql
SELECT * FROM users WHERE email = '$input_email' AND password = '$input_password';
```

ここで、ユーザーが次のような入力をするとどうなるでしょう？

- `$input_email` に： `hacker@example.com' OR '1'='1`
- `$input_password` に： `password`

するとSQLはこうなります：

```sql
SELECT * FROM users WHERE email = 'hacker@example.com' OR '1'='1' AND password = 'password';
```

`'1'='1'` は常に真なので、**本当はログインしてはいけない人もログインできてしまう**ことがあります。

### ✅ セキュリティ対策

- SQL文を**手書きで組み立てない**
- Laravelなどのフレームワークを使って**プリペアドステートメント（バインディング）**で処理する

### ✅ Laravelでの対策例

```php
// OK：クエリビルダを使って値を自動でバインド
$user = DB::table('users')
          ->where('email', $request->input('email'))
          ->where('password', $request->input('password'))
          ->first();
```

または、Eloquentを使えばより安全：

```php
$user = User::where('email', $request->email)
            ->where('password', $request->password)
            ->first();
```

---

## 💥 XSS（クロスサイトスクリプティング）

### 📌 詳細説明
フォームやURLなどに**悪いスクリプト（JavaScriptなど）**を混ぜて、それを他のユーザーのブラウザ上で動かす攻撃。

例えば、掲示板の書き込み欄にこんな内容を投稿された場合：

```html
<script>alert('あなたの情報を盗みます');</script>
```

これがそのまま表示されると、ページを見た他のユーザーの画面でこのJavaScriptが実行されてしまう。

### ✅ セキュリティ対策

- **HTMLを表示する前にエスケープする**（記号を無害な形に変える）
- JavaScriptを直接入力できないように制限する

### ✅ Laravelでの対策例

LaravelのBladeテンプレートは**自動的にエスケープ**してくれる：

```blade
<!-- これは自動でエスケープされる！ -->
{{ $comment->body }}
```

もし「どうしてもHTMLとして表示したい」ときは、自己責任で：

```blade
<!-- 非推奨。使うときは注意！ -->
{!! $comment->body !!}
```

---

## 🎭 CSRF（クロスサイトリクエストフォージェリ）

### 📌 詳細説明
ユーザーがログインしている状態を悪用して、**勝手に操作をさせる攻撃**。

### どんなときに起きる？

ユーザーがログインしているときに、  
「悪意のある第三者のサイト」から、ユーザーの代わりに**勝手にリクエスト（命令）を送る**ことで発生します。

### 具体例：高校の購買サイトを例に説明

あなたが学校の購買部のサイト（`http://school-shop.com`）で、  
パンやジュースを買うことができるとします。

ある日、あなたがログインしている状態で、  
「クラスメイトのいたずらサイト（`http://evil-site.com`）」を開いたとしましょう。

そのサイトの中に、こんなコードが隠れていました：

```html
<img src="http://school-shop.com/buy?item=100個パン&price=5000" />
```

このコードは、見た目にはただの画像ですが、  
実際には**school-shop.com に勝手にリクエストを送る**コードなんです！

### 🤯 どうなるの？

- あなたはログイン中なので、クッキーにログイン情報が入っている
- その状態で悪意のあるページを開くと、自動的にリクエストが送られる
- サイト側は「ログインしてる人の命令」と思って処理してしまう
- 結果：勝手に5000円分のパンが買われる！！

### 😰 なぜ怖いの？

- **本人が何も操作してないのに、命令が通る**
- **銀行、ECサイト、SNSなどで悪用されると大変なことに！**

### ✅ セキュリティ対策

- **CSRFトークン（確認用の秘密キー）を使って、本物の操作かチェックする**

    攻撃者が勝手にフォームやリクエストを送れないように、  
    **「このリクエストは本当に自分が出したものか？」**を証明する仕組みが必要です。

    その代表が **CSRFトークン** です。


### ✅ Laravelでの対策例

Laravelでは、CSRF対策が**標準で自動的に組み込まれています**。

### 🔒 トークンをHTMLに自動埋め込み

Bladeテンプレートでフォームを書くとき、次のように書きます：

```blade
<form method="POST" action="/purchase">
    @csrf
    <input type="text" name="item">
    <button type="submit">購入</button>
</form>
```

`@csrf` を書くことで、**隠しフィールドにランダムなトークン（使い捨てのカギ）**が埋め込まれます。

### 🧠 サーバー側では…

リクエストが送られたとき、そのトークンが正しいかどうかを**自動で検証**します。  
トークンが間違っていれば、そのリクエストは**無視されます**。

### 📌 注意点

- `GET`リクエストではCSRF対策は基本されない（ただし安全な操作だけに使う）
- `POST`、`PUT`、`DELETE`などはCSRF対策を必ず行う
- JavaScriptやAPIで送るときも、ヘッダーにトークンを入れる必要がある

Laravelのルート定義でも、`web` ミドルウェアにより CSRF 保護が有効になっている。

---

## 🔐 パスワードの平文保存

### 📌 詳細説明
ユーザーのパスワードを**そのまま（平文）で保存してしまう**こと。  
もしデータベースが流出したら、全員のパスワードが一目でわかってしまう。

### ✅ セキュリティ対策

- パスワードは**ハッシュ化（ぐちゃぐちゃにして元に戻せない形に変換）**して保存する
- ハッシュには bcrypt や Argon2 などの**安全なアルゴリズム**を使う

### ✅ Laravelでの対策例

```php
use Illuminate\Support\Facades\Hash;

// 登録時
$user->password = Hash::make($request->password);

// ログイン時のチェック
if (Hash::check($request->password, $user->password)) {
    // パスワードが一致
}
```

---

## 📂 ディレクトリトラバーサル

### 📌 詳細説明
本来アクセスできない**サーバー内のファイルに不正アクセス**する攻撃。  
たとえば、画像を表示する処理で `../` を使って一つ上の階層に移動し、秘密ファイルを読もうとする：

```url
http://example.com/show?file=../../.env
```

### ✅ セキュリティ対策

- ユーザーにファイル名を直接指定させない
- ファイルパスを自動生成 or 限定された中から選ばせる
- Laravelではストレージを使い、アクセスをコントロールする

### ✅ Laravelでの対策例

Laravelのストレージ機能を使って安全にファイルを扱う：

```php
Storage::disk('local')->put('example.txt', '内容');
$content = Storage::get('example.txt');
```

---

## 🔒 セッションハイジャック

### 📌 詳細説明
ログイン中のユーザーの「セッションID（＝本人を識別するカギ）」を盗んで、**その人になりすましてアクセスする攻撃**。

盗まれると、ログインしなくてもその人になれてしまう！

### ✅ セキュリティ対策

- セッションIDを安全な方法で管理する
- HTTPS（暗号化通信）を使って盗まれにくくする
- ログイン時やログアウト時にセッションIDを再生成する

### ✅ Laravelでの対策例

Laravelはログイン時に自動でセッションIDを再生成：

```php
Auth::login($user); // セッションID自動再生成
```

また、HTTPS環境であれば `.env` に以下の設定を追加：

```env
SESSION_SECURE_COOKIE=true
```

---

## 🧨 OSコマンドインジェクション（OS Command Injection）

### 📌 詳細説明  
Webアプリが外部でOSコマンド（LinuxやWindowsの命令）を使っているときに、  
**入力に悪意ある命令を混ぜて、システムを操作される攻撃**。

たとえば、ファイル名の入力を受け取って、次のように実行しているとします：

```php
$output = shell_exec("cat " . $_GET['filename']);
```

ここでユーザーが `filename` に `example.txt; rm -rf /` と入力したら、  
ファイルの表示と一緒に、**サーバーのすべてのデータが削除される**かもしれません。

### ✅ セキュリティ対策

- そもそもOSコマンドを使わない（LaravelではStorageなどを使う）
- どうしても使う場合は `escapeshellarg()` を使って安全に文字列を処理する

### ✅ Laravelでの対策例

```php
use Illuminate\Support\Facades\Storage;

// Laravelの安全なファイル読み込み
$content = Storage::get('example.txt');
```

---

## 🧾 HTTPヘッダインジェクション（HTTP Header Injection）

### 📌 詳細説明  
ユーザーが入力する内容に**改行文字（\r\nなど）を混ぜて**、  
HTTPヘッダーを不正に追加したり、レスポンスを書き換えたりする攻撃。

たとえば、次のように動的にLocationヘッダーを設定していた場合：

```php
header("Location: " . $_GET['url']);
```

ここで `url` に `http://evil.com\r\nSet-Cookie: session=steal` と入力されたら、  
ブラウザに悪意あるCookieが設定される危険がある。

### ✅ セキュリティ対策

- 改行文字（`\r` や `\n`）が含まれていないかを確認
- Laravelの `redirect()` や `response()->header()` を使うと安全に処理される

### ✅ Laravelでの対策例

```php
// 安全なリダイレクト
return redirect()->away($validatedUrl);

// ヘッダーの追加（Laravelが自動で安全処理）
return response('OK')->header('X-Custom', 'SafeValue');
```

---

## 🚪 フォースブラウジング（Forceful Browsing）

### 📌 詳細説明  
**URLを直接入力して、本来アクセスできないページに入ろうとする攻撃**。

たとえば、ログインしていないのに `/admin` ページを直接開こうとするなど。

### ✅ セキュリティ対策

- **認証（auth）と権限（authorization）をしっかりチェックする**
- Laravelではミドルウェアでルートごとに制限をかける

### ✅ Laravelでの対策例

```php
// 管理者専用ページ
Route::get('/admin', [AdminController::class, 'index'])
    ->middleware(['auth', 'can:isAdmin']);
```

---

## 🔑 ブルートフォース攻撃（Brute Force Attack）

### 📌 詳細説明  
ログイン画面などで、**パスワードを何度も試して当てようとする攻撃**。  
「0000〜9999」など、すべての組み合わせを総当たりで試す。

### ✅ セキュリティ対策

- ログイン試行回数を制限する（一定回数を超えたら一時ロック）
- CAPTCHAや二段階認証を導入する

### ✅ Laravelでの対策例

Laravelでは `ThrottleRequests` ミドルウェアを使えば簡単に制限可能：

```php
Route::post('/login', [LoginController::class, 'login'])
    ->middleware('throttle:5,1'); // 1分に5回まで
```

また、Laravel Fortify や Breeze などのログイン機能にはデフォルトで制限がついている。

---

## 🖱 クリックジャッキング（Clickjacking）

### 📌 詳細説明  
**透明なボタンやiframeを使って、ユーザーに見えない操作をさせる攻撃**。  
たとえば、透明な「購入ボタン」を重ねて、ユーザーがクリックすると勝手に購入されてしまう。

### ✅ セキュリティ対策

- サイトを iframe で読み込めないようにする（X-Frame-Options ヘッダー）
- Laravelではカスタムミドルウェアで対応できる

### ✅ Laravelでの対策例

```php
// app/Http/Middleware/ClickjackingProtection.php
public function handle($request, Closure $next)
{
    $response = $next($request);
    $response->headers->set('X-Frame-Options', 'DENY');
    return $response;
}
```

このミドルウェアをルートや全体に適用する。

---

## 📦 XXE（XML外部実体参照）

### 📌 詳細説明  
XMLパーサーが**外部ファイルや外部URLを読み込む「エンティティ」機能を悪用される攻撃**。

攻撃者が用意したXMLファイルで、サーバーの `.env` ファイルを読み取ったり、他サイトに攻撃を送ったりできる。

### ✅ セキュリティ対策

- XMLパーサーで外部エンティティを無効化する
- JSONや他の形式を使用する

### ✅ Laravelでの対策例

Laravelでは基本的にJSON形式を使用するため、XXEの影響は少ない。  
もしXMLを扱う場合は以下のように設定：

```php
$xml = new \DOMDocument();
$xml->resolveExternals = false;
$xml->substituteEntities = false;
$xml->loadXML($inputXml, LIBXML_NOENT | LIBXML_DTDLOAD); // これは使わないように
```

安全なライブラリ（例えばSimpleXML）を使う場合も設定に注意。

---

## 🧠 アプリケーション・バッファオーバーフロー

### 📌 詳細説明  
プログラムが用意していた**メモリの範囲（バッファ）を超えて入力を書き込まれる攻撃**。  
結果として、**プログラムが壊れたり、悪意のコードが実行されたり**することがある。

主にC/C++のような低レベル言語で起きるが、PHPアプリでも外部ライブラリ経由で影響を受けることがある。

### ✅ セキュリティ対策

- 入力サイズの制限
- フレームワークや安全な言語機能を使う

### ✅ Laravelでの対策例

LaravelではPHPを使用しており、バッファオーバーフローのリスクは低い。  
ただし、バリデーションは常に重要：

```php
$request->validate([
  'name' => 'required|string|max:255',
]);
```

---

## 🧾 キャッシュの制御不備

### 📌 詳細説明  
**本来キャッシュしてはいけない個人情報やセッション情報を、誤ってキャッシュ**してしまう脆弱性。  
ログイン後のページがキャッシュされて、他のユーザーがその情報を見られてしまう可能性もある。

### ✅ セキュリティ対策

- 機密情報を含むページはキャッシュを禁止する
- レスポンスヘッダーでキャッシュを制御する

### ✅ Laravelでの対策例

```php
return response()
    ->view('profile')
    ->header('Cache-Control', 'no-store, no-cache, must-revalidate')
    ->header('Pragma', 'no-cache');
```

または、グローバルミドルウェアとしてキャッシュ制御を追加することも可能。

---

## 🧠 まとめ

| 脆弱性の名前 | 攻撃内容 | 主な対策 |
|--------------|----------|-----------|
| SQLインジェクション | データベースの乗っ取り | プレースホルダー／バリデーション |
| XSS | 悪意のスクリプト | 自動エスケープ |
| CSRF | 勝手に操作 | CSRFトークン |
| パスワードの平文保存 | パスワードがバレる | ハッシュ化 |
| ディレクトリトラバーサル | ファイルの不正アクセス | パス制限／バリデーション |
| セッションハイジャック | なりすまし | セッション保護・HTTPS |
| OSコマンドインジェクション | システム命令の乗っ取り | OSコマンドを使わない／エスケープ |
| HTTPヘッダインジェクション | ヘッダーの書き換え | 改行除去／Laravelのヘルパー使用 |
| フォースブラウジング | 不正アクセス | 認可ミドルウェアの使用 |
| ブルートフォース | 総当たりパスワード攻撃 | 試行制限／二段階認証 |
| クリックジャッキング | 意図しない操作を誘導 | X-Frame-Options 設定 |
| XXE | XMLで外部参照を悪用 | 外部エンティティ無効化 |
| バッファオーバーフロー | メモリ破壊・乗っ取り | 入力サイズの制限 |
| キャッシュ制御不備 | 機密情報の漏洩 | キャッシュ無効化ヘッダー |

---

## 関連記事
[駆け出しエンジニアの皆さんに知ってほしい脆弱性のこと。](https://zenn.dev/ad5/articles/5e4e67c9663e4e0d0cb0)

[Webアプリケーション　脆弱性チェックリスト](https://qiita.com/defunty/items/c0daca880215831ed5f1)

[Web制作におけるセキュリティの基礎知識（後編）](https://liginc.co.jp/web/useful/168579)